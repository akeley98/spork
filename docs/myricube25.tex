% xelatex </dev/null myricube25.tex
% This has nothing to do with spork/Exo-GPU but it's here anyway...
%
% Background: voxel rendering
%   Memory-intensive
%   Cubic growth in detail (without tricks)
%   Fast rendering - more upfront work
%   Fast loading & edits -- less upfront work
%   Real-world applications: OMG none
%
% Compute vs. graphics
%   Explicit vs implicit parallelism
%
% Vertex Shading
%
% Fragment Shading
%
% Voxels-to-triangles
%
% Raycasting
%
% Both: translate voxel grid to another format
%   Zero-in on data that matters
%   Skip work
%
% Magic of graphics pipeline
%
% Implicit sequential semantics
%
% Workload balancing
%
% Early z-culling
%
% Chunks: 16 × 16 × 16 voxels
%   AABB
%   Draw AABB (12 triangles), raycast only within chunk
%
% Demo 1
%
% Reverse Painters
%   Only waste 12 tringles, not thousands/millions
%
% Upload from disk
%
% Demo 2
\input{slides_common.tex}

\tikzstyle{arrow} = [thick,->,>=stealth]
\tikzstyle{line} = [thick]

\tikzstyle{basic} = [rectangle, minimum height=1cm, text centered, draw=black, fill=white, text=black]
\tikzstyle{redstyle} = [draw=redBoxFg, fill=redBoxBg, text=redBoxFg]
\tikzstyle{yellowstyle} = [draw=yellowBoxFg, fill=yellowBoxBg, text=yellowBoxFg]
\tikzstyle{greenstyle} = [draw=greenBoxFg, fill=greenBoxBg, text=greenBoxFg]
\tikzstyle{bluestyle} = [draw=blueBoxFg, fill=blueBoxBg, text=blueBoxFg]
\tikzstyle{violetstyle} = [draw=violetBoxFg, fill=violetBoxBg, text=violetBoxFg]
\tikzstyle{nRedstyle} = [draw=nRedBoxFg, fill=nRedBoxBg, text=nRedBoxFg]
\tikzstyle{nGoldstyle} = [draw=nGoldBoxFg, fill=nGoldBoxBg, text=nGoldBoxFg]
\tikzstyle{nGreenstyle} = [draw=nGreenBoxFg, fill=nGreenBoxBg, text=nGreenBoxFg]
\tikzstyle{nBluestyle} = [draw=nBlueBoxFg, fill=nBlueBoxBg, text=nBlueBoxFg]
\tikzstyle{nPurplestyle} = [draw=nPurpleBoxFg, fill=nPurpleBoxBg, text=nPurpleBoxFg]
\tikzstyle{cheesyvertex} = [text width=2mm, text height=2mm, anchor=center]

\begin{document}

\hfill\myBiggerTitle{Myricube: Adventures in Voxel Rendering \& Fast Edits}

\includegraphics[width=\linewidth]{myricube/title.jpg}

\newpage
\myBiggerTitle{Voxel Rendering Background}

{\LARGE

3D voxel grid $\to$ 2D color image

Voxel = int-aligned $1 \times 1 \times 1$ cube

\begin{itemize}
  \item Opaque color, or ``transparent'' (for my purposes)
\end{itemize}

Minecraft render distance is lame: why is it hard to scale?

\vfill

\includegraphics[width=\linewidth]{myricube/background_0.jpg}

}

\newpage
\myBiggerTitle{Voxel Rendering Scaling Challenges}

{\LARGE

Challenge: memory-intensive (cubic-ish in render distance)

Challenge: High \# of triangles, sharp detail (low pixels per voxel)

\vfill

\includegraphics[width=0.4\linewidth]{myricube/background_1.jpg}
\includegraphics[width=0.4\linewidth]{myricube/background_2.jpg}

}

\newpage
\myBiggerTitle{Voxel Rendering Goals}

{\LARGE
My goals: think Minecraft, not scientific visualization

\vspace{4mm}

\begin{enumerate}
  \item High render distance at full detail (no level-of-detail)
  \item Fast rendering (motivates \myKeyA{more} upfront work)
  \item Fast loading \& edits (motivates \myKeyA{less} upfront work)
\end{enumerate}

\vspace{4mm}

Real-world applications... OMG, NONE!

Ex post facto goal: learn Vulkan and convince Nvidia to hire me

}

\newpage
\myBiggerTitle{GPU: Compute vs Graphics API}

{\large
\begin{tikzpicture}[node distance=0mm]
\node (cpu) [basic, text width=42mm] {\textbf{CPU} API calls};
\node (compute) [basic, text width=42mm, anchor=north east, yshift=-4mm] at(cpu.south west) {\textbf{Compute API}\\e.g. CUDA};
\node (graphics) [basic, text width=42mm, anchor=north west, yshift=-4mm] at(cpu.south east) {\textbf{Graphics API}\\e.g. OpenGL};

\node (grids) [basic, text width=60mm, anchor=north, yshift=-4mm] at(compute.south) {\textbf{Verb:} launch grids\\ (\myKeyA{explicitly parallel})};
\node (triangles) [basic, text width=80mm, anchor=north, yshift=-4mm] at(graphics.south) {\textbf{Verb:} draw triangles / primitives\\ (\myKeyA{sequential semantics}, mostly)};

\node (gpu) [basic, thick, draw=nGreenBoxBg, text width=190mm, anchor=north, text height=26mm, yshift=-46mm] at(cpu.south) {};
\node (vertex) [basic, nPurplestyle, text width=55mm, anchor=north, yshift=-50mm] at(cpu.south) {Runs\\\textbf{Vertex Shaders}\\(positions each vertex)};
\node (fragment) [basic, greenstyle, text width=55mm, anchor=west, xshift=6mm] at(vertex.east) {Runs\\\textbf{Fragment Shaders}\\(colors interior pixels)};
\node (thread) [basic, text width=55mm, anchor=east, xshift=-6mm] at(vertex.west) {Runs\\\textbf{CUDA Threads}\\(grouped into CTAs)};
\node (gpuCaption) [text=nGreenBoxBg, anchor=north west] at(gpu.south west) {\textbf{Execution on programmable GPU}};

\draw [arrow] (cpu.south) to[out=270, in=0] (compute.east);
\draw [arrow] (cpu.south) to[out=270, in=180] (graphics.west);
\draw [line] (compute.south) -- (grids.north);
\draw [line] (graphics.south) -- (triangles.north);
\draw[arrow] (grids.south) to[out=270, in=90] (thread.north);
\draw[arrow] (triangles.south) to[out=270, in=90] (vertex.north);
\draw[arrow] (triangles.south) to[out=270, in=90] (fragment.north);

\node (v0) [yshift=-20mm, xshift=+3mm, fill=nPurpleBoxBg, cheesyvertex] at(vertex.south) {};
\node (v1) [yshift=-10mm, xshift=+43mm, fill=nPurpleBoxBg, cheesyvertex] at(vertex.south) {};
\node (v2) [yshift=-35mm, xshift=+30mm, fill=nPurpleBoxBg, cheesyvertex] at(vertex.south) {};
\fill [greenBoxBg] (v0.center) -- (v1.center) -- (v2.center) -- cycle;

\draw [arrow, dotted] (vertex) -- (v0);
\draw [arrow, dotted] (vertex) -- (v1);
\draw [arrow, dotted] (vertex) -- (v2);
\draw [arrow, dotted] (fragment.south) to[out=270, in=0] ($(v2)!0.5!(v1) + (-0.3,0)$);

\node (etc) [text width=80mm, yshift=-6mm, anchor=north west] at(gpuCaption.south west) {Not shown, GPU primitive gen:\\geometry, tess, mesh, task shaders};

\end{tikzpicture}
}
\newpage
\myBiggerTitle{Vertex Shading (Triangle Strip Topology)}

{\large
\begin{tikzpicture}[node distance=0mm]

\node (vb00) [basic, text width=10mm, text height=10mm, anchor=north] {};
\node (vb01) [basic, text width=10mm, text height=10mm, anchor=north] at(vb00.south) {};
\node (vb02) [basic, text width=10mm, text height=10mm, anchor=north] at(vb01.south) {};
\node (vb03) [basic, text width=10mm, text height=10mm, anchor=north] at(vb02.south) {};
\node (vb04) [basic, text width=10mm, text height=10mm, anchor=north] at(vb03.south) {};
% \node (vb05) [text centered, text width=10mm, anchor=north] at(vb04.south) {\Huge $\downarrow$\\$\downarrow$};

\node (text0) [anchor=east, text height=10mm] at(vb00.west) {Vertex 0};
\node (text1) [anchor=east, text height=10mm] at(vb01.west) {Vertex 1};
\node (text2) [anchor=east, text height=10mm] at(vb02.west) {Vertex 2};
\node (text3) [anchor=east, text height=10mm] at(vb03.west) {Vertex 3};
\node (text4) [anchor=east, text height=10mm] at(vb04.west) {Vertex 4};
\node (text5) [text centered, text height=10mm, anchor=north] at(text4.south) {Vertex ...};

\node (vb10) [basic, text width=10mm, text height=10mm, anchor=west, xshift=8mm] at(vb00.east) {};
\node (vb11) [basic, text width=10mm, text height=10mm, anchor=north] at(vb10.south) {};
\node (vb12) [basic, text width=10mm, text height=10mm, anchor=north] at(vb11.south) {};
\node (vb13) [basic, text width=10mm, text height=10mm, anchor=north] at(vb12.south) {};
\node (vb14) [basic, text width=10mm, text height=10mm, anchor=north] at(vb13.south) {};
% \node (vb15) [text centered, text width=10mm, anchor=north] at(vb14.south) {\Huge $\downarrow$\\$\downarrow$};

\node (vb0) [text centered, anchor=north] at(vb04.south) {Buffer 0};
\node (vb1) [text centered, anchor=north] at(vb14.south) {Buffer 1...};
\node (vbo) [text centered, text width=30mm, anchor=south] at($(vb00.north)!0.5!(vb10.north)$) {\textbf{Vertex\\Buffer\\Attributes}};

\node (u0) [anchor=center, xshift=17mm] at(vb10.east) {};
\node (u1) [anchor=center, xshift=17mm] at(vb11.east) {};
\node (u2) [anchor=center, xshift=17mm] at(vb12.east) {};
\node (u3) [anchor=center, xshift=17mm] at(vb13.east) {};
\node (u4) [anchor=center, xshift=17mm] at(vb14.east) {};
\node (u5) [anchor=center, yshift=-10mm] at(u4.south) {};

\node (uniforms) [text centered, text width=30mm, anchor=south, yshift=8mm] at(u0.north) {\textbf{Uniforms\\from CPU}};

\draw [arrow] (uniforms.south) to[out=270, in=135] (u0.west);
\draw [arrow] (u0.south) to[out=270, in=135] (u1.west);
\draw [arrow] (u1.south) to[out=270, in=135] (u2.west);
\draw [arrow] (u2.south) to[out=270, in=135] (u3.west);
\draw [arrow] (u3.south) to[out=270, in=135] (u4.west);
\draw [arrow] (u4.south) to[out=270, in=135] (u5.west);

\node (vs0) [basic, text width=10mm, text height=10mm, anchor=west, xshift=16mm, fill=nRedBoxBg, text=white] at(u0.east) {VS};
\node (vs1) [basic, text width=10mm, text height=10mm, anchor=west, xshift=16mm, fill=nGoldBoxBg, text=white] at(u1.east) {VS};
\node (vs2) [basic, text width=10mm, text height=10mm, anchor=west, xshift=16mm, fill=nGreenBoxBg, text=white] at(u2.east) {VS};
\node (vs3) [basic, text width=10mm, text height=10mm, anchor=west, xshift=16mm, fill=nBlueBoxBg, text=white] at(u3.east) {VS};
\node (vs4) [basic, text width=10mm, text height=10mm, anchor=west, xshift=16mm, fill=nPurpleBoxBg, text=white] at(u4.east) {VS};
% \node (vs5) [text centered, text width=10mm, anchor=north] at(vs4.south) {\Huge $\downarrow$\\$\downarrow$};

\node (vs) [text centered, text width=80mm, anchor=north, yshift=-2mm] at(vs4.south) {\textbf{Vertex Shaders\\1 Vertex = 1 Thread}};
\node (strip) [text centered, text width=80mm, anchor=west] at(vs.east) {\textbf{\myKeyA{Ordered} Triangles\\Each 3 Adjacent Vertices\\$\to$ 1 Triangle}};

\node (oa00) [basic, text width=10mm, text height=10mm, anchor=west, xshift=9mm] at(vs0.east) {};
\node (oa01) [basic, text width=10mm, text height=10mm, anchor=north] at(oa00.south) {};
\node (oa02) [basic, text width=10mm, text height=10mm, anchor=north] at(oa01.south) {};
\node (oa03) [basic, text width=10mm, text height=10mm, anchor=north] at(oa02.south) {};
\node (oa04) [basic, text width=10mm, text height=10mm, anchor=north] at(oa03.south) {};
% \node (oa05) [text centered, text width=10mm, anchor=north] at(oa04.south) {\Huge $\downarrow$\\$\downarrow$};

\node (oa10) [basic, text width=10mm, text height=10mm, anchor=west, xshift=4mm] at(oa00.east) {};
\node (oa11) [basic, text width=10mm, text height=10mm, anchor=north] at(oa10.south) {};
\node (oa12) [basic, text width=10mm, text height=10mm, anchor=north] at(oa11.south) {};
\node (oa13) [basic, text width=10mm, text height=10mm, anchor=north] at(oa12.south) {};
\node (oa14) [basic, text width=10mm, text height=10mm, anchor=north] at(oa13.south) {};
% \node (oa15) [text centered, text width=10mm, anchor=north] at(oa14.south) {\Huge $\downarrow$\\$\downarrow$};

\node (out) [text centered, text width=30mm, anchor=south] at($(oa00.north)!0.5!(oa10.north)$) {\textbf{Output\\Vertex\\Attributes}};

\draw [arrow, thick, draw=nRedBoxBg] ($(vb00.west) + (3mm ,0)$) -- (vs0.west);
\draw [arrow, thick, draw=nGoldBoxBg] ($(vb01.west) + (3mm ,0)$) -- (vs1.west);
\draw [arrow, thick, draw=nGreenBoxBg] ($(vb02.west) + (3mm ,0)$) -- (vs2.west);
\draw [arrow, thick, draw=nBlueBoxBg] ($(vb03.west) + (3mm ,0)$) -- (vs3.west);
\draw [arrow, thick, draw=nPurpleBoxBg] ($(vb04.west) + (3mm ,0)$) -- (vs4.west);

\draw [arrow, thick, draw=nRedBoxBg] (vs0.east) -- ($(oa10.east) - (3mm ,0)$);
\draw [arrow, thick, draw=nGoldBoxBg] (vs1.east) -- ($(oa11.east) - (3mm ,0)$);
\draw [arrow, thick, draw=nGreenBoxBg] (vs2.east) -- ($(oa12.east) - (3mm ,0)$);
\draw [arrow, thick, draw=nBlueBoxBg] (vs3.east) -- ($(oa13.east) - (3mm ,0)$);
\draw [arrow, thick, draw=nPurpleBoxBg] (vs4.east) -- ($(oa14.east) - (3mm ,0)$);

\node (rasterizer) [text centered, text width=60mm, anchor=west] at(out.east) {\textbf{Primitive Assembly\\\&\\Rasterizer}};

\node (v0) [cheesyvertex, fill=nRedBoxBg, anchor=center, xshift=16mm] at(oa10.east) {};
\node (v1) [cheesyvertex, fill=nGoldBoxBg, anchor=center, xshift=42mm] at(oa11.east) {};
\node (v2) [cheesyvertex, fill=nGreenBoxBg, anchor=center, xshift=16mm] at(oa12.east) {};
\node (v3) [cheesyvertex, fill=nBlueBoxBg, anchor=center, xshift=42mm] at(oa13.east) {};
\node (v4) [cheesyvertex, fill=nPurpleBoxBg, anchor=center, xshift=16mm] at(oa14.east) {};

\draw [line] (v0) -- (v1);
\draw [line] (v1) -- (v2);
\draw [line] (v2) -- (v3);
\draw [line] (v3) -- (v4);
\draw [line] (v0) -- (v2);
\draw [line] (v1) -- (v3);
\draw [line] (v2) -- (v4);

\end{tikzpicture}
}

\newpage
\myBiggerTitle{Fragment Shading}

{\large
\begin{tikzpicture}[node distance=0mm]

\node(for) [text centered, text width=75mm] {For each triangle \myKeyA{in order},\\ for each pixel in the triangle,\\\hphantom{M}\\1 shaded pixel = 1 thread (sorta)};

\node(screen) [basic, text width=60mm, text height=40mm, anchor=west] at(for.east) {};
\node(controls) [anchor=north east] at(screen.north east) {$-\Box\times$};  % LOL
\node(dv0) [fill=gray, cheesyvertex, anchor=center, xshift=10mm, yshift=-10mm] at(screen.north west) {};
\node(dv1) [fill=gray, cheesyvertex, anchor=center, xshift=18mm, yshift=-34mm] at(screen.north west) {};
\node(dv2) [fill=gray, cheesyvertex, anchor=center, xshift=50mm, yshift=-13mm] at(screen.north west) {};
\node(dPixel) [fill=black, cheesyvertex, anchor=center, xshift=20mm, yshift=-22mm] at(screen.north west) {};
\draw [dotted] (dv0) -- (dv1);
\draw [dotted] (dv0) -- (dv2);
\draw [dotted] (dv1) -- (dv2);

\node(dColor) [anchor=north east] at(screen.south east) {\textbf{Dest. Color}};
\node(dDepth) [anchor=north east] at(dColor.south east) {\textbf{Dest. Depth}};
\node(sColor) [anchor=north east] at(dDepth.south east) {\textbf{Src. Color}};
\node(sDepth) [anchor=north east] at(sColor.south east) {\textbf{Src. Depth}};

\node(write) [basic, text width=25mm, minimum height=25mm, anchor=west, xshift=45mm] at(dPixel.east) {Write back\\new color,\\new depth};
\draw [arrow] (write.west) -- (dPixel.east);
\node(OR) [anchor=west] at(write.east) {\textbf{OR}};
\node(discard) [basic, text width=25mm, minimum height=25mm, anchor=west] at(OR.east) {\myKeyA{DISCARD}};

\node(sv0) [fill=nRedBoxBg, cheesyvertex, anchor=center, yshift=-75mm] at(dv0.center) {};
\node(sv1) [fill=nGoldBoxBg, cheesyvertex, anchor=center, yshift=-75mm] at(dv1.center) {};
\node(sv2) [fill=nGreenBoxBg, cheesyvertex, anchor=center, yshift=-75mm] at(dv2.center) {};
\node(vs) [anchor=west, xshift=4mm, yshift=2mm] at(sv1.east) {(from vertex shaders)};
\node(sPixel) [fill=black, cheesyvertex, anchor=center, yshift=-75mm] at(dPixel.center) {};
\draw [dotted] (sv0) -- (sv1);
\draw [dotted] (sv0) -- (sv2);
\draw [dotted] (sv1) -- (sv2);

\node(blending) [basic, anchor=north, yshift=-25mm] at(OR.south) {Blending};
\draw [arrow] (blending) -- ($(OR)+(0, -9mm)$);
\node(depthTest) [basic, text width=40mm, anchor=north, yshift=-8mm] at(blending.south) {Depth Test\\\myKeyA{MAY DISCARD}};

\draw [arrow] (dColor.east) to[out=0, in=180] ($(blending.west)+(0, 2mm)$);
\draw [arrow] (sColor.east) to[out=0, in=180] ($(blending.west)+(0, -2mm)$);
\draw [arrow] (dDepth.east) to[out=0, in=180] ($(depthTest.west)+(0, 2mm)$);
\draw [arrow] (sDepth.east) to[out=0, in=180] ($(depthTest.west)+(0, -2mm)$);
\draw [arrow] (dPixel.south) to[out=270, in=180] (dColor.west);
\draw [arrow] (dPixel.south) to[out=270, in=180] (dDepth.west);

\node(fragment) [basic, text width=40mm, anchor=east, xshift=-6mm] at($(sColor.west)!0.5!(sDepth.west)$) {Fragment Shader\\\myKeyA{MAY DISCARD}};
\node(iDepth) [anchor=east, xshift=-66mm] at(sDepth.west) {\textbf{Interpolated Depth}};
\node(uniforms) [anchor=south, yshift=6mm] at(iDepth.north) {\textbf{Uniforms from CPU}};
\node(iAttrs) [anchor=north, yshift=-6mm, text width=50mm] at(iDepth.south) {\textbf{Interpolated Output\\Vertex Attributes}};

\draw [arrow] ($(fragment.east)+(0, +4mm)$) to[out=0, in=180] (sColor.west);
\draw [arrow] ($(fragment.east)+(0, -4mm)$) to[out=0, in=180] (sDepth.west);
\draw [arrow] (iDepth.east) to[out=0, in=180] ($(fragment.west)+(0, -4mm)$);
\draw [arrow] (uniforms.east) to[out=0, in=180] ($(fragment.west)+(0, +4mm)$);
\draw [arrow] (iAttrs.east) to[out=0, in=225] (fragment.south west);
\draw [arrow] (sPixel.west) to[out=180, in=315] (iDepth.south east);
\draw [arrow] (sPixel.west) to[out=180, in=315] (iAttrs.south east);

\end{tikzpicture}
}


\newpage
\myBiggerTitle{Prior Art: Voxels to Triangle Mesh}

\newpage
\myBiggerTitle{Prior Art: Raycasting}

\newpage
\myBiggerTitle{``Research'' Question}

\newpage
\myBiggerTitle{Embarassingly Parallel (but not really)}

\newpage
\myBiggerTitle{Implicit Sequential Semantics}

\newpage
\myBiggerTitle{Workload Balancing}

\newpage
\myBiggerTitle{Early z-culling}

\newpage
\myBiggerTitle{Myricube: Chunks}

\newpage
\myBiggerTitle{Myricube: Reverse Painter's}

\newpage
\myBiggerTitle{Myricube: Uploads from Disk}

\end{document}
